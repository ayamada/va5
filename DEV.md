# va5 開発メモ

## 開発手順

TODO

```
python -m http.server 8001
```

でサーバ起動、
http://localhost:8001/dev/dev.html
を開いて動作確認


## リリース手順

TODO

以下、リリースビルドの為の処理の一時メモ

(src/va5_version.jsの更新)
(最終的には cat src/va5/*.js とかで一つのファイルにする。これがva5.jsになる)
(gccのoptimizationsでmin化。externs対象は「va5直下の小文字で始まるエントリ」のみとなる。「_で始まるエントリ」はprivate(mungeしてok)、「大文字で始まるエントリ」はクラス名(mungeしてok)。トップレベル汚染はva5キーのみ)
(これでva5.min.jsとva5.min.js.mapができる)


## オンラインデモ兼リファレンスのリリースビルド生成およびデプロイ手順

TODO

そもそも、どういう奴にするのかから考える必要が…


## デバッグしづらい部分の動作確認について

- dumbモードでの動作確認
    - 例外が投げられたりコンソールに異常が表示されなければok。音はどうやっても出ない。
    - javascriptの仕様上、該当コードを走らせないと変なところがないか分からないので、走らせる必要がある

- ieでの動作確認
    - 同上。基本的にはdumbモードでの動作になるのだが、「ieではこのjavascript構文に対応していない」等がありえるので、個別の動作確認が必要

- 古いandroid/iOSでの動作確認
    - 同上


## TODO

- dev/prod.html と dev/prod.js の作成
    - min版を生成したら、ここで動作確認を取る
    - これ dev/ というディレクトリ名をやめるべきでは？
        - devとprodの同居はした方がよい(同じ音源ファイルを参照したい)
        - いい名前を考える事
            - resources/public/
            - public_html/
            - ...
            - ...
            - ...


- android実機およびiOSエミュでの動作確認を取る
    - 古いiOS上でgetNowMsecが想定通り動くか確認を取る事
    - タッチのみで動作確認が取れるところまで実装を進める事
        - そうしないとandroidとiOSで動作確認が取れない…


## 一時メモ

現状だと「loopStartが未指定の場合はstartPosを流用する」ようになっているが、おそらくこれは逆の方がよい。「startPosが未指定の場合はloopStartを流用する(あれば)」方がよい。なんでかというと、MV互換タグを読み込む際にそうなる方が自然な為
(MVではstartPos endPosがない。またloopStartはあるがloopEndがなくloopLengthでの指定となっている)



- 「bgm/voiceの再生が終了したら自動的にunloadまで行うconfig項目」の追加と実装を行う事
    - ゲーム内のbgmやvoiceの量が多く全てをオンメモリで持つ訳にはいかない場合、この処理が必須になる




- 動作確認を取る
    - va5.getBgmPos(ch);
        - 下記の問題あり、修正して再確認を取る事
    - va5.bgm(path, {});
        - startPos endPos loopStart loopEnd の指定が想定通り動くか確認する事
        - 下記の問題あり、修正して再確認を取る事
    - va5.stopBgm(ch, fadeSec);
        - 下記の問題あり、修正して再確認を取る事


その他の問題点について


バックグラウンド復帰後にstopBgmしてもフェードアウトが始まらない
何らかのステートが残ってしまっている？

バックグラウンド復帰時に最初からの再生に戻ってしまう。直す事
しかし…先にcalcPosを直すべきなのでは？


getBgmPos / device.calcPos の挙動がおかしい。
以下のようになっている。
- ループ時に巻き戻らない
- バックグラウンド一時停止等が起こっても巻き戻らない(おそらく正確になってない)


ループ時に少し無音部分がある
後述の「ファイル形式について」を参照




以下の機能もinterfaceに登録する事を検討



- playBgmの新オプションとして「今流してるoneshotのbgmが終わったら次にこれを再生する」機能を追加
    - bgmNext() とか、別の関数にする？
    - ただこれ普通に設定すると、stop時にも流れてしまうのでは？
        - stop時にはnextStateも消すようにすればよい
            - TODO: 忘れずに実装する事！




checkDeviceSpec(device) みたいな関数を作り、必要な関数が揃っているかチェックできるようにしたい
とりあえず関数としてのエントリが存在するかのチェックだけでよい
普段は実行しない、もしくはinit時のみチェックする感じで
実際のチェック内容としては、「DumbとWebAudioで比較」みたいな感じでよい？
これをマクロっぽい奴なしに行えるか？
(「別にチェックリストを用意する」だと結局チェックリストの更新を忘れて死ぬ)

Object.keys(va5).forEach(function (k) {
if (va5[k] == null) { throw Error("function not found: "+k); }
});
これだと駄目。何故なら大部分の提供関数が、va5.init()を暗黙の内に実行する為に、
functionでラッピングしているから。また _device のチェックにもならない。
マクロ的に、コメントからのusage抽出と同様に組むしかないのでは？



- usageはinterface.js内にコメントで書いて、それをスクリプトで抽出する？



## 仕様一時メモ

あとで消すか、「その他のメモ」に移動させる事

isOneshot=falseで再生し、その後にisOneshot=trueでconnectした際に、isOneshotが反映されない問題あり。しかしこれはどうしようもないので仕様とする事に


- va5での新仕様
    - jsのみ
    - ビルドはMakefileかshスクリプトかなんかで行う。webpackは使わない
        - gccのoptimizationsで圧縮する。externsファイルも用意する
    - deviceレイヤの分離はva4同様に行うが、HtmlAudio対応はしない。WebAudioとdumbのみ用意する
        - 将来にelectron対応等しやすいようにしておく
    - ie非対応。無音で通す
        - edgeについては一応通す
            - edgeでdecodeに失敗する可能性のある可変ビットレートmp3は諦める。固定ビットレートmp3=もしくはm4a推奨とする
                - 後述のファイル形式の問題あり
    - 古いスマホ非対応。無音で通す
        - どう判定するかが問題。WebAudio非対応なら問題ないが、中途半端に対応している時期のものが問題になる
    - 音源のfallback(wildcard)指定は廃止。指定した音源が再生できないものだった場合は無音で通す
        - 推奨形式はm4a。次点で固定ビットレートのmp3。ogg等は再生できない環境があるという事が分かっているなら指定できる(electron実行のみ等で)
            - 後述のファイル形式の問題あり

- va4から引き継ぐべき仕様について
    - va4の各種バッドノウハウ対策を組み込む
    - https://qiita.com/zprodev/items/7fcd8335d7e8e613a01f - にあるリーク対策等を組み込む

- voice実装メモ
    - 扱いとしてはseではなく、「oneshotのみのbgm」的な扱いにする
        - 各チャンネルでの同時発声数を1に抑える為




## その他のメモ

- assertを仕込む際のルール
    - 可能な限り例外は投げない(assertは常用しない)
        - 通常はvalidateの方を使う
            - たとえ引数ミスのようなものであっても、コンソールにのみエラーを出す。例外は投げない
            - validateは不正な値が渡ってきた場合でも例外を投げない。内部で勝手に丸め込んで処理する
                - 一部、丸め込みのできないタイプの値(path等)があり、それはnullを返すが、そういうものの場合はnullかどうかをチェックし何も処理しないようにすればよい
        - 通常は絶対起こらないようなところにだけassertを仕込む(内部の異常を検知する)



## ファイル形式についての考察

- mp3
    - WebAudioがサポートされているほとんどの環境で再生可能
    - 可変ビットレートだとedge系で再生エラーになる事がある。固定ビットレート推奨
    - エンコーダが勝手に無音部分を曲の頭に追加してしまう(lame系のみ？)。とても問題になる
        - これをやらないオプションもしくはエンコーダを探す必要がある
            - lameの場合、 `-nogap` というオプションがあるようだ
                - その他のオプション一覧 http://yamaken.tokyo/2019/03/24/post-171/
            - lamejsを試す？ https://github.com/zhuker/lamejs
                - ライセンスはLGPL
    - mp3の仕様上、曲の長さはフレーム単位になる必要がある。44100Hzなら0.0261秒単位。なので曲の末尾にわずかに無音部分が付いてしまう
        - これはmp3の仕様なので避けられない。しかしmp3曲頭の無音やm4aの末尾無音と比べると大した量ではないので許容範囲内

- m4a
    - WebAudioがサポートされているほとんどの環境で再生可能
    - デコーダによっては勝手に無音部分を曲の最後に追加してしまう。SEでは問題ないがループBGMで問題になる
        - safari等のapple系デコーダは問題ないようだ
        - chromeおよびaudacityに代表されるffmpegを利用するデコーダは少し無音部分を追加してしまう
        - firefoxのデコーダはかなり多めの無音部分を追加してしまう

- ogg
    - mp3やm4aにある無音部分追加の問題はない
    - edgeとモバイル系ブラウザで再生できない問題がある(古いfirefoxも)



ではどうするか？

- va4のように、複数種類の音源ファイルを用意する
    - これはしたくない…ファイルは一個だけにしたい

- mp3で、曲頭に無音部分を追加しないエンコーダかlameオプションを探して対応
    - まあまあ問題ないのでは？

- ツクールMVのように、曲にloopStartとloopEndタグを埋め込む(ファイル形式はmp3かm4aか好きな方を選べる)
    - これがベストか？
    - エンコーダ側の設定が面倒だが…

- ツクールMVのように、wasmでoggをデコードする
    - これはデコーダのwasmを別に用意する必要があるので避けたい(配布サイズ増加およびライセンスの面で)

- 独自のエンコーダ/デコーダを採用する
    - https://github.com/redlily/training-webaudio-compression のような奴
    - ちょっと大変すぎない？
    - エンコードは低速でもよいが、デコードは可能な限り高速なのが望ましいので、nativeな実装か、wasmの実装がほしいところ

- 他に良い手はあるか？



